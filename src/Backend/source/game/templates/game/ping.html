<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pong Game Test</title>
    <style>
        .game-container {
            width: 800px;
            margin: 20px auto;
            text-align: center;
        }
        #gameCanvas {
            border: 2px solid black;
            background: #000;
        }
        .controls {
            margin: 20px 0;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .auth-status {
            color: red;
            margin: 10px 0;
        }

        .game-chat {
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        .chat-input input {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .chat-input button {
            background: #28a745;
        }

        .chat-input button:hover {
            background: #218838;
        }

        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            background: #fff;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Pong Game Test</h1>
        <div class="auth-status" id="authStatus"></div>
        <div class="status" id="connectionStatus">Status: Disconnected</div>
        <div class="score">
            Player 1: <span id="score1">0</span> | 
            Player 2: <span id="score2">0</span>
        </div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
        <div class="controls">
            <button id="readyBtn">Ready</button>
        </div>
    </div>

    <script>
        let ws = null;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusDisplay = document.getElementById('connectionStatus');
        const authStatus = document.getElementById('authStatus');
        const readyBtn = document.getElementById('readyBtn');
        const score1Display = document.getElementById('score1');
        const score2Display = document.getElementById('score2');

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }

            return cookieValue;
        }

        function checkAuthenticationStatus() {
            const csrftoken = getCookie('csrftoken');
            const accessToken = getCookie('access_token');
            const refreshToken = getCookie('refresh_token');
            
            if (!accessToken || !refreshToken) {
                authStatus.textContent = 'Error: No access or refresh token found.';
                return false;
            }
            if (!csrftoken) {
                authStatus.textContent = 'Error: No CSRF token found.';
                return false;
            }
            
            authStatus.textContent = '';
            return true;
        }

        function connectWebSocket() {
            if (!checkAuthenticationStatus()) {
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/game/`;
            
            // Create WebSocket connection with cookies
            ws = new WebSocket(wsUrl);
            
            // Add cookies to WebSocket handshake
            ws.onbeforeopen = () => {
                const sessionid = getCookie('sessionid');
                const csrftoken = getCookie('csrftoken');
                ws.setRequestHeader('Cookie', `sessionid=${sessionid}; csrftoken=${csrftoken}`);
            };

            ws.onopen = () => {
                statusDisplay.textContent = 'Status: Connected - Waiting for opponent';
                authStatus.textContent = '';
            };

            ws.onclose = (event) => {
                statusDisplay.textContent = 'Status: Disconnected';
                if (event.code === 4001) {
                    authStatus.textContent = 'Authentication failed. Please log in.';
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                statusDisplay.textContent = 'Status: Connection error';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateGameState(data);
            };
        }

        function updateGameState(gameState) {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw game elements
            ctx.fillStyle = '#fff';

            // Draw paddles
            if (gameState.paddle1) {
                ctx.fillRect(20, gameState.paddle1.y, 10, 60);
            }
            if (gameState.paddle2) {
                ctx.fillRect(canvas.width - 30, gameState.paddle2.y, 10, 60);
            }

            // Draw ball
            if (gameState.ball) {
                ctx.beginPath();
                ctx.arc(gameState.ball.x, gameState.ball.y, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Update score
            if (gameState.score) {
                score1Display.textContent = gameState.score.player1;
                score2Display.textContent = gameState.score.player2;
            }

            // Update status
            if (gameState.status) {
                statusDisplay.textContent = `Status: ${gameState.status}`;
                if (gameState.status === 'waiting') {
                    readyBtn.style.display = 'block';
                } else {
                    readyBtn.style.display = 'none';
                }
            }
        }

        // Event listeners
        canvas.addEventListener('mousemove', (e) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const rect = canvas.getBoundingClientRect();
                const y = e.clientY - rect.top;
                ws.send(JSON.stringify({
                    action: 'move_paddle',
                    position: y
                }));
            }
        });

        // Handle ready button
        readyBtn.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'ready'
                }));
                readyBtn.disabled = true;
            }
        });

        // Initial connection
        connectWebSocket();

        // Reconnect on disconnect
        setInterval(() => {
            if (ws === null || ws.readyState === WebSocket.CLOSED) {
                connectWebSocket();
            }
        }, 5000);
    </script>
</body>
</html>