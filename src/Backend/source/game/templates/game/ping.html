<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vertical Pong Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #gameCanvas {
            background: #1a1a1a;
            margin: 20px auto;
            display: block;
            border-radius: 4px;
        }

        .controls-info {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            color: #495057;
            font-size: 12px;
        }

        #readyBtn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        #readyBtn:disabled {
            background: #6c757d;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f8d7da;
            color: #721c24;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="connectionStatus" class="connection-status">
            Connecting to server...
        </div>

        <canvas id="gameCanvas" width="500" height="800"></canvas>

        <div class="controls-info">
            Use ← Left and → Right arrow keys to move your paddle
        </div>

        <button id="readyBtn" disabled>Ready</button>
    </div>

    <script>
        class PongGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.readyBtn = document.getElementById('readyBtn');
                
                // Game state
                this.paddle1X = this.canvas.width / 2 - 20; // Top paddle
                this.paddle2X = this.canvas.width / 2 - 20; // Bottom paddle
                this.paddleWidth = 40;
                this.paddleHeight = 10;
                this.paddleSpeed = 5;
                this.keys = {
                    ArrowLeft: false,
                    ArrowRight: false
                };

                this.gameId = null;
                this.playerNumber = null;
                this.ballX = this.canvas.width / 2;
                this.ballY = this.canvas.height / 2;
                this.scores = { player1: 0, player2: 0 };

                this.setupEventListeners();
                this.connectWebSocket();
                this.startGameLoop();
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
                this.readyBtn.addEventListener('click', () => this.sendReady());
            }

            handleKeyDown(e) {
                if (e.key in this.keys) {
                    e.preventDefault();
                    this.keys[e.key] = true;
                }
            }

            handleKeyUp(e) {
                if (e.key in this.keys) {
                    e.preventDefault();
                    this.keys[e.key] = false;
                }
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/game/`;
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    this.connectionStatus.style.background = '#d4edda';
                    this.connectionStatus.style.color = '#155724';
                    this.connectionStatus.textContent = 'Connected';
                    this.readyBtn.disabled = false;
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'game.update') {
                        this.updateGameState(data.game_state);
                    }
                };

                this.ws.onclose = () => {
                    this.connectionStatus.style.background = '#f8d7da';
                    this.connectionStatus.style.color = '#721c24';
                    this.connectionStatus.textContent = 'Disconnected';
                    this.readyBtn.disabled = true;
                };
            }

            updateGameState(state) {
                if (!state) return;

                // Update ball position
                if (state.ball) {
                    this.ballX = state.ball.x;
                    this.ballY = state.ball.y;
                }

                // Update paddles and scores
                if (state.players) {
                    const players = Object.values(state.players);
                    if (players[0]) {
                        this.paddle1X = players[0].paddle_x;
                        this.scores.player1 = players[0].score;
                    }
                    if (players[1]) {
                        this.paddle2X = players[1].paddle_x;
                        this.scores.player2 = players[1].score;
                    }
                }
            }

            sendPaddlePosition() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN && this.gameId) {
                    const paddleX = this.playerNumber === 1 ? this.paddle1X : this.paddle2X;
                    this.ws.send(JSON.stringify({
                        action: 'move_paddle',
                        position: paddleX,
                        game_id: this.gameId
                    }));
                }
            }

            sendReady() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        action: 'ready',
                        game_id: this.gameId
                    }));
                    this.readyBtn.disabled = true;
                    this.readyBtn.textContent = 'Waiting...';
                }
            }

            updateGame() {
                // Update paddle position based on keys
                if (this.playerNumber) {
                    const paddleX = this.playerNumber === 1 ? this.paddle1X : this.paddle2X;
                    if (this.keys.ArrowLeft) {
                        this.playerNumber === 1 ? 
                            this.paddle1X = Math.max(0, paddleX - this.paddleSpeed) :
                            this.paddle2X = Math.max(0, paddleX - this.paddleSpeed);
                        this.sendPaddlePosition();
                    }
                    if (this.keys.ArrowRight) {
                        this.playerNumber === 1 ?
                            this.paddle1X = Math.min(this.canvas.width - this.paddleWidth, paddleX + this.paddleSpeed) :
                            this.paddle2X = Math.min(this.canvas.width - this.paddleWidth, paddleX + this.paddleSpeed);
                        this.sendPaddlePosition();
                    }
                }
            }

            draw() {
                // Clear canvas
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw paddles
                this.ctx.fillStyle = '#4169E1';
                this.ctx.fillRect(this.paddle1X, 0, this.paddleWidth, this.paddleHeight); // Top paddle
                this.ctx.fillRect(this.paddle2X, this.canvas.height - this.paddleHeight, this.paddleWidth, this.paddleHeight); // Bottom paddle

                // Draw ball
                this.ctx.beginPath();
                this.ctx.fillStyle = '#FFD700';
                this.ctx.arc(this.ballX, this.ballY, 4, 0, Math.PI * 2);
                this.ctx.fill();

                // Draw scores
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.font = '16px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(this.scores.player1, 20, this.canvas.height / 2 - 10);
                this.ctx.fillText(this.scores.player2, 20, this.canvas.height / 2 + 20);
            }

            startGameLoop() {
                setInterval(() => {
                    this.updateGame();
                    this.draw();
                }, 1000 / 60); // 60 FPS
            }
        }

        // Start the game when the page loads
        window.addEventListener('load', () => {
            new PongGame();
        });
    </script>
</body>
</html>