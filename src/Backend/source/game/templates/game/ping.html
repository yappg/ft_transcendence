<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pong Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #gameCanvas {
            background: #1a1a1a;
            margin: 20px auto;
            display: block;
            border-radius: 4px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .score {
            font-size: 24px;
            font-weight: bold;
        }

        .player-info {
            font-size: 16px;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .controls-info {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            color: #495057;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #readyBtn {
            background: #28a745;
            color: white;
        }

        #readyBtn:hover {
            background: #218838;
        }

        #readyBtn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .waiting {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Pong Game</h1>
        
        <div class="status-bar">
            <div class="player-info" id="player1Info">Player 1</div>
            <div class="score">
                <span id="score1">0</span> - <span id="score2">0</span>
            </div>
            <div class="player-info" id="player2Info">Player 2</div>
        </div>

        <div id="connectionStatus" class="connection-status disconnected">
            Connecting to server...
        </div>

        <canvas id="gameCanvas" width="600" height="400"></canvas>

        <div class="controls-info">
            Use ↑ Up and ↓ Down arrow keys to move your paddle
        </div>

        <div class="controls">
            <button id="readyBtn" disabled>Ready</button>
        </div>
    </div>

    <script>
        class PongGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.readyBtn = document.getElementById('readyBtn');
                this.score1 = document.getElementById('score1');
                this.score2 = document.getElementById('score2');
                this.player1Info = document.getElementById('player1Info');
                this.player2Info = document.getElementById('player2Info');
                
                this.ws = null;
                this.gameState = {
                    status: 'waiting',
                    paddle1: { y: 170 },
                    paddle2: { y: 170 },
                    ball: { x: 300, y: 200 },
                    score: { player1: 0, player2: 0 }
                };

                // Paddle movement state
                this.paddleSpeed = 5;
                this.keys = {
                    ArrowUp: false,
                    ArrowDown: false
                };

                this.setupEventListeners();
                this.connectWebSocket();
                this.startGameLoop();
            }

            setupEventListeners() {
                // Keyboard controls
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
                this.readyBtn.addEventListener('click', () => this.sendReady());
                window.addEventListener('beforeunload', () => this.cleanup());
            }

            handleKeyDown(e) {
                if (e.key in this.keys) {
                    e.preventDefault();
                    this.keys[e.key] = true;
                }
            }

            handleKeyUp(e) {
                if (e.key in this.keys) {
                    e.preventDefault();
                    this.keys[e.key] = false;
                }
            }

            updatePaddlePosition() {
                if (this.keys.ArrowUp) {
                    this.gameState.paddle1.y = Math.max(0, this.gameState.paddle1.y - this.paddleSpeed);
                    this.sendPaddlePosition();
                }
                if (this.keys.ArrowDown) {
                    this.gameState.paddle1.y = Math.min(this.canvas.height - 60, this.gameState.paddle1.y + this.paddleSpeed);
                    this.sendPaddlePosition();
                }
            }

            startGameLoop() {
                setInterval(() => {
                    this.updatePaddlePosition();
                    this.draw();
                }, 1000 / 60); // 60 FPS
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/game/`;
                
                this.ws = new WebSocket(wsUrl);
                
                // Add authentication headers
                const headers = new Headers();
                headers.append('X-CSRFToken', this.getCookie('csrftoken'));
                headers.append('Authorization', `Bearer ${this.getCookie('access_token')}`);
                
                this.ws.onopen = () => this.handleConnectionOpen();
                this.ws.onclose = (event) => this.handleConnectionClose(event);
                this.ws.onerror = (error) => this.handleError(error);
                this.ws.onmessage = (event) => this.handleMessage(event);
            }

            getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            handleConnectionOpen() {
                this.connectionStatus.className = 'connection-status connected';
                this.connectionStatus.textContent = 'Connected - Waiting for opponent';
                this.readyBtn.disabled = false;
            }

            handleConnectionClose(event) {
                this.connectionStatus.className = 'connection-status disconnected';
                this.connectionStatus.textContent = event.code === 4001 ? 
                    'Authentication failed. Please log in.' : 
                    'Disconnected from server';
                this.readyBtn.disabled = true;
                
                setTimeout(() => this.connectWebSocket(), 5000);
            }

            handleError(error) {
                console.error('WebSocket error:', error);
                this.connectionStatus.className = 'connection-status disconnected';
                this.connectionStatus.textContent = 'Connection error occurred';
            }

            handleMessage(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received message:', data);
                    if (data.type === 'game_state') {
                        this.updateGameState(data.state);
                    } else if (data.type === 'error') {
                        console.error('Game error:', data.message);
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            }

            updateGameState(state) {
                this.gameState = state;
                this.score1.textContent = state.score.player1;
                this.score2.textContent = state.score.player2;
                
                if (state.status === 'waiting') {
                    this.connectionStatus.className = 'connection-status waiting';
                    this.connectionStatus.textContent = 'Waiting for both players to be ready';
                } else if (state.status === 'playing') {
                    this.connectionStatus.className = 'connection-status connected';
                    this.connectionStatus.textContent = 'Game in progress';
                    this.readyBtn.disabled = true;
                }
            }

            draw() {
                // Clear canvas
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw center line
                this.ctx.strokeStyle = '#333';
                this.ctx.setLineDash([5, 15]);
                this.ctx.beginPath();
                this.ctx.moveTo(this.canvas.width / 2, 0);
                this.ctx.lineTo(this.canvas.width / 2, this.canvas.height);
                this.ctx.stroke();
                this.ctx.setLineDash([]);

                // Draw paddles with different colors
                // Left paddle (Player 1) - Blue
                this.ctx.fillStyle = '#4169E1';
                this.ctx.fillRect(20, this.gameState.paddle1.y, 10, 60);
                
                // Right paddle (Player 2) - Red
                this.ctx.fillStyle = '#DC143C';
                this.ctx.fillRect(this.canvas.width - 30, this.gameState.paddle2.y, 10, 60);

                // Draw ball with gradient
                const ballGradient = this.ctx.createRadialGradient(
                    this.gameState.ball.x, this.gameState.ball.y, 0,
                    this.gameState.ball.x, this.gameState.ball.y, 8
                );
                ballGradient.addColorStop(0, '#FFD700');  // Gold center
                ballGradient.addColorStop(1, '#FFA500');  // Orange edge
                
                this.ctx.beginPath();
                this.ctx.fillStyle = ballGradient;
                this.ctx.arc(this.gameState.ball.x, this.gameState.ball.y, 8, 0, Math.PI * 2);
                this.ctx.fill();
            }

            sendPaddlePosition() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        action: 'move_paddle',
                        position: this.gameState.paddle1.y
                    }));
                }
            }

            sendReady() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        action: 'ready'
                    }));
                    this.readyBtn.disabled = true;
                }
            }

            cleanup() {
                if (this.ws) {
                    this.ws.close();
                }
            }
        }

        // Start the game when the page loads
        window.addEventListener('load', () => {
            const game = new PongGame();
        });
    </script>
</body>
</html>